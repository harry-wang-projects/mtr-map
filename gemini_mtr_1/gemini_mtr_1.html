<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MTR Island Line - High Speed Simulator</title>
    <style>
        :root {
            --mtr-blue: #0071ce;
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #eef2f7;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            max-width: 1400px;
            width: 100%;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        h1 {
            color: var(--mtr-blue);
            font-size: 22px;
            letter-spacing: -0.5px;
        }
        
        .stats {
            display: flex;
            gap: 15px;
            font-size: 13px;
            font-weight: 600;
            color: #444;
        }

        .stat-box {
            background: #f8f9fa;
            padding: 5px 12px;
            border-radius: 20px;
            border: 1px solid #ddd;
        }

        .stat-box span { color: var(--mtr-blue); }
        
        #map {
            width: 100%;
            height: 500px;
            border-radius: 8px;
            z-index: 1;
        }

        .dashboard {
            margin-top: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            background: #fdfdfd;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #eee;
        }

        .control-item {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .control-item label {
            font-size: 12px;
            font-weight: bold;
            color: #666;
            text-transform: uppercase;
        }

        .control-item input[type="range"] {
            width: 100%;
            accent-color: var(--mtr-blue);
        }

        .val-display {
            font-family: monospace;
            font-size: 14px;
            color: var(--mtr-blue);
            float: right;
        }

        @media (max-width: 768px) {
            #map { height: 350px; }
            .header { flex-direction: column; gap: 10px; }
        }
    </style>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>MTR Island Line Simulator</h1>
            <div class="stats">
                <div class="stat-box">Trains: <span id="train-count">0</span></div>
                <div class="stat-box">Ticks: <span id="tick-count">0</span></div>
                <div class="stat-box" id="status-box">Status: <span>Spawning</span></div>
            </div>
        </div>
        
        <div id="map"></div>

        <div class="dashboard">
            <div class="control-item">
                <label>Tick Speed (Ticks/Sec) <span class="val-display" id="v-speed">1</span></label>
                <input type="range" id="i-speed" min="1" max="120" value="1">
            </div>
            <div class="control-item">
                <label>Travel Time (Secs) <span class="val-display" id="v-travel">90</span></label>
                <input type="range" id="i-travel" min="10" max="300" value="90">
            </div>
            <div class="control-item">
                <label>Station Dwell (Secs) <span class="val-display" id="v-dwell">10</span></label>
                <input type="range" id="i-dwell" min="0" max="60" value="10">
            </div>
            <div class="control-item">
                <label>Spawn Interval (Secs) <span class="val-display" id="v-spawn">120</span></label>
                <input type="range" id="i-spawn" min="30" max="600" value="120">
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // --- CONSTANTS & STATE ---
        const stations = [
            { name: "Kennedy Town", lat: 22.2810, lng: 114.1289 },
            { name: "HKU", lat: 22.2840, lng: 114.1350 },
            { name: "Sai Ying Pun", lat: 22.2860, lng: 114.1430 },
            { name: "Sheung Wan", lat: 22.2870, lng: 114.1510 },
            { name: "Central", lat: 22.2820, lng: 114.1580 },
            { name: "Admiralty", lat: 22.2790, lng: 114.1650 },
            { name: "Wan Chai", lat: 22.2770, lng: 114.1730 },
            { name: "Causeway Bay", lat: 22.2800, lng: 114.1850 },
            { name: "Tin Hau", lat: 22.2820, lng: 114.1920 },
            { name: "Fortress Hill", lat: 22.2880, lng: 114.1940 },
            { name: "North Point", lat: 22.2910, lng: 114.2000 },
            { name: "Quarry Bay", lat: 22.2890, lng: 114.2120 },
            { name: "Tai Koo", lat: 22.2850, lng: 114.2170 },
            { name: "Sai Wan Ho", lat: 22.2810, lng: 114.2230 },
            { name: "Shau Kei Wan", lat: 22.2790, lng: 114.2290 },
            { name: "Heng Fa Chuen", lat: 22.2770, lng: 114.2390 },
            { name: "Chai Wan", lat: 22.2650, lng: 114.2370 }
        ];

        let config = {
            tickSpeed: 1,      // Ticks per real second
            travelTime: 90,    // Ticks between stations
            dwellTime: 10,     // Ticks at station
            spawnInterval: 120 // Ticks between spawns
        };

        let trains = [];
        let totalTicks = 0;
        let spawnTimer = 0;
        let spawningActive = true;
        let lastTimestamp = 0;
        let tickAccumulator = 0;

        // --- MAP INITIALIZATION ---
        // Using OpenStreetMap standard tiles for better visibility
        const map = L.map('map').setView([22.2800, 114.1850], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        const lineCoords = stations.map(s => [s.lat, s.lng]);
        L.polyline(lineCoords, { 
            color: '#0071ce', 
            weight: 5, 
            opacity: 0.7 
        }).addTo(map);

        stations.forEach(s => {
            L.circleMarker([s.lat, s.lng], {
                radius: 4, fillColor: 'white', color: '#0071ce', weight: 2, fillOpacity: 1
            }).bindTooltip(s.name).addTo(map);
        });

        // --- TRAIN CLASS ---
        class Train {
            constructor(id, isLead = false) {
                this.id = id;
                this.isLead = isLead;
                this.currentIndex = 0;
                this.nextIndex = 1;
                this.direction = 1; // 1: Forward, -1: Backward
                this.state = 'STOPPED'; // STOPPED or MOVING
                this.timer = 0;
                this.completedCycle = false;

                this.marker = L.circleMarker([stations[0].lat, stations[0].lng], {
                    radius: 7,
                    fillColor: '#0071ce', // Same as line color
                    color: '#ffffff',
                    weight: 2,
                    fillOpacity: 1
                }).addTo(map);
                
                this.marker.bindTooltip(`Train ${id}`, { direction: 'top' });
            }

            update() {
                this.timer++;

                if (this.state === 'STOPPED') {
                    if (this.timer >= config.dwellTime) {
                        this.state = 'MOVING';
                        this.timer = 0;
                        this.setNextTarget();
                    }
                } else {
                    if (this.timer >= config.travelTime) {
                        this.state = 'STOPPED';
                        this.timer = 0;
                        this.currentIndex = this.nextIndex;
                        
                        // Check for cycle completion (Lead train back at start)
                        if (this.isLead && this.currentIndex === 0 && this.direction === -1) {
                            this.completedCycle = true;
                        }
                    }
                }
                this.draw();
            }

            setNextTarget() {
                if (this.currentIndex === stations.length - 1 && this.direction === 1) {
                    this.direction = -1;
                } else if (this.currentIndex === 0 && this.direction === -1) {
                    this.direction = 1;
                }
                this.nextIndex = this.currentIndex + this.direction;
            }

            draw() {
                const start = stations[this.currentIndex];
                const end = stations[this.nextIndex] || start;

                if (this.state === 'STOPPED') {
                    this.marker.setLatLng([start.lat, start.lng]);
                } else {
                    const progress = this.timer / config.travelTime;
                    const lat = start.lat + (end.lat - start.lat) * progress;
                    const lng = start.lng + (end.lng - start.lng) * progress;
                    this.marker.setLatLng([lat, lng]);
                }
            }
        }

        // --- SIMULATION ENGINE ---
        function runTick() {
            totalTicks++;
            spawnTimer++;

            // Spawning logic
            if (spawningActive && (trains.length === 0 || spawnTimer >= config.spawnInterval)) {
                const isLead = (trains.length === 0);
                trains.push(new Train(trains.length + 1, isLead));
                spawnTimer = 0;
            }

            // Update trains
            trains.forEach(t => {
                t.update();
                if (t.isLead && t.completedCycle) {
                    spawningActive = false;
                    document.getElementById('status-box').innerHTML = 'Status: <span style="color:#e67e22">Looping</span>';
                }
            });

            // Update UI
            document.getElementById('tick-count').innerText = totalTicks;
            document.getElementById('train-count').innerText = trains.length;
        }

        // High-precision loop
        function mainLoop(timestamp) {
            if (!lastTimestamp) lastTimestamp = timestamp;
            const elapsedMs = timestamp - lastTimestamp;
            lastTimestamp = timestamp;

            // Calculate how many ticks should have occurred in this timeframe
            // based on the user-defined tickSpeed (Ticks per Second)
            tickAccumulator += (elapsedMs / 1000) * config.tickSpeed;

            while (tickAccumulator >= 1) {
                runTick();
                tickAccumulator -= 1;
            }

            requestAnimationFrame(mainLoop);
        }

        // --- CONTROLS & INPUTS ---
        const inputs = [
            { id: 'i-speed', key: 'tickSpeed', display: 'v-speed' },
            { id: 'i-travel', key: 'travelTime', display: 'v-travel' },
            { id: 'i-dwell', key: 'dwellTime', display: 'v-dwell' },
            { id: 'i-spawn', key: 'spawnInterval', display: 'v-spawn' }
        ];

        inputs.forEach(input => {
            const el = document.getElementById(input.id);
            const disp = document.getElementById(input.display);
            
            el.addEventListener('input', (e) => {
                const val = parseInt(e.target.value);
                config[input.key] = val;
                disp.innerText = val;
            });
        });

        // Start
        requestAnimationFrame(mainLoop);
        map.fitBounds(lineCoords, { padding: [30, 30] });
    </script>
</body>
</html>

